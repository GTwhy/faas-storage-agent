# 架构介绍

## 概览
本项目主要由4个部分组成，分别为存储代理服务、认证服务、语言库以及应用模板。开发者只要在应用模板中使用存储代理库中的API编写业务逻辑后，便可通过faas-cli生成Serverless应用并自动部署运行。应用的存储请求会由集群中的存储代理服务接收，经认证服务验证通过后转发到后端存储平台。
![](https://whypics.oss-cn-shenzhen.aliyuncs.com/pics/20210925180643.png)
### 存储代理服务
使用Rust编写，作为kubernetes的daemonset应用运行在集群的每个节点中，为函数应用提供存储代理服务,代码见agent_server/。代理服务器接收来自函数应用的存储代理请求，收到请求后根据配置信息将请求转化为后端数据平台的数据及命名空间操作。

由于每个节点都需要有一个代理服务器为节点中的函数服务，因此代理服务是作为Daemonset应用部署的，用于部署的配置文件见yaml/agent-ds-*。其中包括了较为常用的aarch64和x86_64的版本。

另外由于集群中部署的容器ip是不固定的，因此openfaas的函数应用不能使用ip:port的方式直接与代理服务器通信，需要Kubernetes的Service提供存储代理服务的域名，完成请求的转发。部署Service的配置文件见yaml/agent-svc.yaml。

代理服务编译、测试打包镜像，在集群中部署Daemonset、Service以及部署完毕之后的集成测试等操作都由自动化脚本控制，可借助Github Actions完成，详见.github/local_ci.yaml。
### 认证服务
认证服务为用户对命名空间和数据的操作提供授权和鉴权服务，代码见auth_server/。当前借助Django-oauth-toolkit实现了一个简单可用的版本，可通过网页可视化管理或程序脚本等方式对应用权限进行授权。当代理服务收到应用请求后会使用其附带的token请求认证服务器进行鉴权。

认证服务可以采用任意支持OAuth2.0的认证服务产品，可以是第三方产品也可以自建认证服务器。将认证界面与FaaS函数和存储管理的界面整合在同一界面可提高用户体验。

### 语言库
语言库封装了使用grpc对处于同一节点上的存储代理服务进行请求的各种功能,代码见language_libs/。库中提供了获取授权信息，如token、client_id、client_secret等信息，需要配合相应的环境变量使用。

鉴于Python是当前FaaS领域应用最多的语言，因此首先支持了Python。又由于每个函数应用往往只处理一个简单的逻辑，常以KV的形式存储关系简单的数据，因此语言库首先支持了Python语言的KV形式的存储API。当前主要支持了(key：String， value: bytes)形式的数据存取和查询操作，该方式较为通用，应用面较广。后续可以支持更多数据类型的API，方便用户使用。

### 应用模板
基于openfaas平台的函数应用模板，可通过faas-cli的new命令一键创建函数应用，并通过up命令一键部署应用到集群中，代码见template/。应用模板中包含了语言库等环境信息，同时在用户编写逻辑的handler文件中以注释的形式给出了使用语言库的示例。

应用模板也是编程语言相关的，目前支持了Python，其他语言的应用模板可仿照该Python模板，通过修改对应语言的openfaas官方模板得到。